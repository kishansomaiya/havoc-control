import { JSDOM } from 'jsdom';
import { promises as fsp, readFileSync, readdirSync, rmSync } from "fs";
import sharp from "sharp";
import nodepath from "node:path";
import {
    vehicleBaseDirectory,
    vehiclesDistDirectory,
    colorMapping,
    backdropConfig,
    imageThemeConfig
} from "./vehicleConfigs.js";

/**
 * Takes a svg string, converts it to a png file, and saves it to the output path
 * @param {string} svgString - SVG string
 * @param {string} outputPath - Path to save the SVG image (as png) 
 */
export async function convertSvgToPng(svgString, outputPath) {
    try {
        const outputBuffer = await sharp(Buffer.from(svgString))
            .png()
            .toBuffer();

        await fsp.mkdir(nodepath.dirname(outputPath), { recursive: true });
        await fsp.writeFile(outputPath, outputBuffer);
    } catch (error) {
        console.error(`Error converting SVG, output path ${outputPath}, with Sharp:`, error);
    }
}

/**
 * Replaces the svg path fill color and opacity with the options set in our config file 
 * @param {Document} document - Document generated by JSDOM
 * @param {{[key: "outline" | "primary" | "secondary"] : NodeListOf<Element>[]}} svgPaths - Object of all the paths in the svg grouped by their fill color
 * @param {{[key: "outline" | "primary" | "secondary"] : {color: string, opacity: number}}} options - Object of the various themes and ship states to specify how to set the svg path fills/opacity
 * @param {string} savePath - Our save path compiled by the file name and path type we're saving
 */
export async function processPathSaveNewAttributes(document, svgPaths, options, savePath) {
    for (let [pathType, paths] of Object.entries(svgPaths)) {
        for (let path of paths) {
            path.setAttribute("fill", options[pathType]?.color ?? "white");
            path.setAttribute("fill-opacity", options[pathType]?.opacity ?? "1");
        }
    }

    await convertSvgToPng(document.querySelector("#svgContainer").innerHTML, savePath);
}

/**
 * Paints the svg content onto the jsdom and processes it so that we can generate a backdrop image and the various theme/ship state images
 * @param {string} svgContent - SVG string
 * @param {string} folderName - Name of folder we will generate to store the images
 */
export async function convertSvgPathsToPng(svgContent, folderName) {
    const dom = new JSDOM(`<!DOCTYPE html><body><div id="svgContainer">${svgContent}</div></body>`);
    const document = dom.window.document;
    const svgPaths = {};

    // Get nodelist of all the paths matching our color mapping and add a className so we can reference it later
    for (let [color, pathType] of Object.entries(colorMapping)) {
        svgPaths[pathType] = document.querySelectorAll(`path[fill="${color}" i]`);
    }

    // Process backdrop first
    await processPathSaveNewAttributes(document, svgPaths, backdropConfig, `${vehiclesDistDirectory}/${folderName}/backdrop.png`)

    // Process the various themes and ship states
    for (let [themeName, vehicleStates] of Object.entries(imageThemeConfig)) {
        for (let [filename, options] of Object.entries(vehicleStates)) {
            const savePath = `${vehiclesDistDirectory}/${folderName}/${themeName}/${filename}.png`;
            await processPathSaveNewAttributes(document, svgPaths, options, savePath)
        }
    }
}

// Deletes all the previously generated files to make room for the new
try {
    readdirSync(vehiclesDistDirectory).forEach((fileName) => rmSync(`${vehiclesDistDirectory}/${fileName}`, { recursive: true }));
} catch (e) {
    // Directory doesn't exists, no need to handle it since it's fine
}

// Gets all the base vehicle file names and loops through them for processing 
readdirSync(vehicleBaseDirectory).forEach((fileName) => {
    // Make sure we're processing svg files (mainly to ignore the readme)
    const splitFile = fileName.split(".");
    const fileExtension = splitFile.pop().toLocaleLowerCase();
    if (fileExtension === "md") {
        // Ignore Readme
        return;
    }
    if (fileExtension !== "svg") {
        console.warn(`Ignoring ${fileName} since it's not a svg file.`);
        return;
    }

    const svgContent = readFileSync(`${vehicleBaseDirectory}/${fileName}`, 'utf8');
    convertSvgPathsToPng(svgContent, splitFile.join("."))
        .then(() => console.log(`File '${fileName}' processed and folder/image files created`))
        .catch((err) => console.error(`Error processing SVG's:`, err));
})
